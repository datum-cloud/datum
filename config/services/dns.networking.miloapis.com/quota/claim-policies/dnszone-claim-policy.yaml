apiVersion: quota.miloapis.com/v1alpha1
kind: ClaimCreationPolicy
metadata:
  name: project-dnszone-claim-policy
  labels:
    app.kubernetes.io/name: datum
    app.kubernetes.io/component: quota-system
spec:
  trigger:
    resource:
      apiVersion: dns.networking.miloapis.com/v1alpha1
      kind: DNSZone
    constraints:
      - expression: "has(trigger.metadata.labels['resourcemanager.miloapis.com/project'])"
        message: "DNSZone must be labeled with 'resourcemanager.miloapis.com/project'"
      - expression: "has(trigger.metadata.labels['resourcemanager.miloapis.com/organization'])"
        message: "DNSZone must be labeled with 'resourcemanager.miloapis.com/organization'"
  target:
    resourceClaimTemplate:
      metadata:
        name: "dnszone-{{ trigger.metadata.name }}"
        namespace: "organization-{{ trigger.metadata.labels['resourcemanager.miloapis.com/organization'] }}"
        labels:
          app.kubernetes.io/name: datum
          app.kubernetes.io/component: quota-system
          quota.miloapis.com/auto-created: "true"
          quota.miloapis.com/policy: "project-dnszone-claim-policy"
        annotations:
          kubernetes.io/description: "Automatic quota claim for DNSZone creation"
      spec:
        consumerRef:
          apiGroup: "resourcemanager.miloapis.com"
          kind: "Project"
          name: "{{ trigger.metadata.labels['resourcemanager.miloapis.com/project'] }}"
        requests:
          - resourceType: dns.networking.miloapis.com/dnszones
            amount: 1


